<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Tetris</title>
        <style>
            table {
                /* tetris field table should have a ratio 2:1 */
                border: 1px solid black;
                width: 300px;
                height: 600px;
            }
        </style>
    </head>
    <body>
        <h1>Tetris</h1>
        <!-- empty table, this will be the tetris field -->
        <table id="tetris"></table>

        <script>
            // constants
            const nr_rows = 20;
            const nr_columns = 10;
            const tetris_table = document.getElementById("tetris");

            // field
            let field = {
                field: [],

                spawn: function() {
                    // add empty rows and cells to the field matrix
                    for (let i = 0; i < nr_rows; i++) {
                        field.field[i] = new Array(nr_columns);
                    }
                    // add field to DOM
                    for (let i = 0; i < nr_rows; i++) {
                        let newRow = tetris_table.insertRow(0);
                        for (j = 0; j < nr_columns; j++) {
                            let newCell = newRow.insertCell(0);
                            // put text in the cell otherwise we can not give it a color later on
                            newCell.appendChild(document.createTextNode(" "));
                        }
                    }
                },

                add_block: function(row, column, color) {
                    // add block to field
                    field.field[row][column] = true;

                    // make block visible in DOM
                    const DOM_row = document.querySelectorAll("tr")[row];
                    const DOM_block = DOM_row.querySelectorAll("td")[column];
                    DOM_block.setAttribute("bgcolor", color);
                },

                remove_block: function(row, column) {
                    // remove block from field
                    field.field[row][column] = false;

                    // remove block from DOM
                    const DOM_row = document.querySelectorAll("tr")[row];
                    const DOM_block = DOM_row.querySelectorAll("td")[column];
                    DOM_block.removeAttribute("bgcolor");
                },

                validate_cell: function(row, column) {
                    if (row >= nr_rows || row < 0 || column >= nr_columns || column < 0) {
                        // new position is outside the field
                        return false;
                    }
                    if (field.field[row][column] === true) {
                        // new position is already occupied
                        return false;
                    } else {
                        // position is available
                        return true;
                    }
                },

                validate_fullrow: function(row) {
                    for (let column = 0; column < nr_columns; column++) {
                        if (field.field[row][column] != true) {
                            // note: cells can be true, false, or undefined
                            return false;
                        }
                    }
                    return true;
                }
            };

            // active block
            let active_block = {
                spawn: function(row, column, color) {
                    active_block.row = row;
                    active_block.column = column;
                    active_block.color = color;
                    field.add_block(row, column, color);
                },

                move: function(delta_row, delta_column) {
                    const new_row = active_block.row + delta_row;
                    const new_column = active_block.column + delta_column;
                    const current_row = active_block.row;
                    const current_column = active_block.column;

                    // check if move is legal
                    if (field.validate_cell(new_row, new_column)) {
                        // update position
                        active_block.row = new_row;
                        active_block.column = new_column;

                        // update DOM
                        field.remove_block(current_row, current_column);
                        field.add_block(new_row, new_column, active_block.color);

                        // check cell below the block
                        if (field.validate_cell(new_row + 1, new_column) === false) {
                            // the block is fixed so spawn a new one!
                            active_block.spawn(0, 4, "red");
                        }
                    }
                }
            };

            // start game
            field.spawn();
            active_block.spawn(0, 4, "red");

            // event listeners:
            window.addEventListener("keyup", function(e) {
                // press space (= 32) to create a block in the intial positin
                if (e.keyCode === 32) {
                    // TODO: implement action for spacebar
                }

                // left: 37
                if (e.keyCode === 37) {
                    active_block.move(0, -1);
                }

                // right: 39
                if (e.keyCode === 39) {
                    active_block.move(0, 1);
                }

                // up: 38
                if (e.keyCode === 38) {
                    active_block.move(-1, 0);
                }

                // down: 40
                if (e.keyCode === 40) {
                    active_block.move(1, 0);
                }
            });
        </script>
    </body>
</html>
